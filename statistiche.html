<!DOCTYPE HTML>
<!--
  Phantom by HTML5 UP
  html5up.net | @ajlkn
  Free for personal and commercial use under the CCA 3.0 license
-->
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Statistiche – Gestionale</title>

  <!-- Phantom CSS -->
  <link rel="stylesheet" href="assets/css/main.css" />
  <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
</head>
<body>

  <!-- Wrapper -->
  <div id="wrapper">

    <!-- Header small con back -->
    <header id="header">
      <div class="inner">
        <a href="index.html" class="button small">← Home</a>
        <h2>Statistiche</h2>
      </div>
    </header>

    <!-- Main: griglia di canvas -->
    <div id="main">
      <div class="inner">
        <div class="grid-style">
          <section><canvas id="chartSede"></canvas></section>
          <section><canvas id="chartTeam"></canvas></section>
          <section><canvas id="chartContract"></canvas></section>
          <section><canvas id="chartAmbito"></canvas></section>
          <section><canvas id="chartClients"></canvas></section>
        </div>
      </div>
    </div>

    <!-- Footer minimale -->
    <footer id="footer">
      <div class="inner">
        <ul class="copyright">
          <li>&copy; Gestionale Dipendenti</li>
        </ul>
      </div>
    </footer>

  </div>

  <!-- Carico SUPABASE e CHART.JS PRIMA del mio script -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- Script inline per le statistiche -->
  <script>
    // 1) Configuro Supabase
    const sb = supabase.createClient(
      'https://fzbpucvscnfyimefrvzs.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…'
    );
    console.log('SUPABASE CLIENT:', sb);

    const TABLE = 'application_specialists';

    // 2) Al caricamento, disegno i grafici
    document.addEventListener('DOMContentLoaded', loadStats);

    async function loadStats() {
      const { data, error } = await sb
        .from(TABLE)
        .select('sede,team,contratto,ambito,clienti');

      if (error) {
        alert('Errore statistiche: ' + error.message);
        return;
      }

      renderPie('chartSede',     'AS per Sede',      countBy(data,'sede'));
      renderPie('chartTeam',     'AS per Team',      countBy(data,'team'));
      renderPie('chartContract', 'AS per Contratto', countBy(data,'contratto'));
      renderPie('chartAmbito',   'AS per Ambito',    countBy(data,'ambito'));
      renderPie('chartClients',  'AS per Clienti',   countBy(data,'clienti'));
    }

    // helper di conteggio
    function countBy(arr, key) {
      return arr.reduce((map, r) => {
        const vals = Array.isArray(r[key]) ? r[key] : [r[key]];
        vals.filter(v => v).forEach(v => {
          map[v] = (map[v] || 0) + 1;
        });
        return map;
      }, {});
    }

    // disegno le pie e loggo per debug
    const charts = {};
    function renderPie(id, title, dataObj) {
      console.log('Rendering pie', id, dataObj);
      const el = document.getElementById(id);
      if (!el) return;
      const ctx = el.getContext('2d');
      if (charts[id]) charts[id].destroy();
      const labels = Object.keys(dataObj);
      const values = Object.values(dataObj);
      const bg = labels.map((_,i) => `hsl(${i*360/labels.length},70%,60%)`);
      charts[id] = new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets:[{ data: values, backgroundColor: bg }] },
        options: {
          plugins: {
            title:  { display:true, text:title },
            legend: { position:'bottom' }
          }
        }
      });
    }
  </script>

  <!-- Phantom JS -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/browser.min.js"></script>
  <script src="assets/js/breakpoints.min.js"></script>
  <script src="assets/js/util.js"></script>
  <script src="assets/js/main.js"></script>

</body>
</html>