<!DOCTYPE HTML>
<!--
  report.html ‚Äì Gestionale Dipendenti
  Genera un report Excel con grafici e lista dipendenti
-->
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Report ‚Äì Gestionale Dipendenti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
</head>
<body>

  <div id="wrapper">
    <header id="header">
      <div class="inner">
        <a href="index.html" class="button small">‚Üê Home</a>
        <h2>Report</h2>
      </div>
    </header>

    <div id="main">
      <div class="inner">
        <p>Clicca per scaricare il report Excel con grafici e lista dipendenti:</p>
        <button id="btnExport" class="button primary">Scarica Report</button>
      </div>
    </div>

    <footer id="footer">
      <div class="inner">
        <ul class="copyright">
          <li>&copy; Gestionale Dipendenti</li>
        </ul>
      </div>
    </footer>
  </div>

  <!-- Caricamento librerie -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Script inline per generare l‚ÄôExcel -->
  <script>
  (async () => {
    console.log('üöÄ report.html avviato');
    console.log('‚Äì ExcelJS:', typeof ExcelJS !== 'undefined' ? 'OK' : 'MANCANTE');
    console.log('‚Äì saveAs:', typeof saveAs !== 'undefined' ? 'OK' : 'MANCANTE');

    // 1) Configura Supabase
    const sb = supabase.createClient(
      'https://fzbpucvscnfyimefrvzs.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9‚Ä¶' // la tua chiave anonima
    );
    const TABLE = 'application_specialists';

    // 2) Conteggio per statistica
    function countBy(arr, key) {
      return arr.reduce((map, r) => {
        const items = Array.isArray(r[key]) ? r[key] : [r[key]];
        items.filter(v => v).forEach(v => map[v] = (map[v]||0) + 1);
        return map;
      }, {});
    }

    // 3) Crea un pie chart off-screen e ritorna solo base64
    function makeChartImage(title, dataObj) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const labels = Object.keys(dataObj);
      const values = Object.values(dataObj);
      const bg     = labels.map((_,i) => `hsl(${i*360/labels.length},70%,60%)`);
      new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets:[{ data: values, backgroundColor: bg }] },
        options: { plugins:{ title:{ display:true, text:title }, legend:{ position:'bottom' } } }
      });
      const full = canvas.toDataURL('image/png');
      // splitto in "data:image/png;base64,XXX" => ["data:...", "XXX"]
      const parts = full.split(',');
      console.log(`üñºÔ∏è ${title}: ${parts[1].length} bytes`);
      return parts[1];
    }

    // 4) Genera e scarica il file Excel
    async function generateExcel() {
      console.log('üì¶ Inizio generazione report');
      // Fetch dei dati
      const [ statRes, listRes ] = await Promise.all([
        sb.from(TABLE).select('sede,team,contratto,ambito,clienti'),
        sb.from(TABLE).select('*').order('created_at', { ascending: false })
      ]);
      if (statRes.error || listRes.error) {
        const err = statRes.error || listRes.error;
        console.error('‚ùå Errore fetch:', err);
        return alert('Errore caricamento dati: ' + err.message);
      }
      const statsData = statRes.data, listData = listRes.data;

      // Workbook
      const wb = new ExcelJS.Workbook();
      wb.creator = 'Gestionale Dipendenti';
      wb.created = new Date();

      // ‚Äî‚Äî‚Äî‚Äî Sheet ‚ÄúStatistiche‚Äù ‚Äî‚Äî‚Äî‚Äî
      const ws1 = wb.addWorksheet('Statistiche');
      let row = 0;
      const configs = [
        ['AS per Sede',      countBy(statsData,'sede')],
        ['AS per Team',      countBy(statsData,'team')],
        ['AS per Contratto', countBy(statsData,'contratto')],
        ['AS per Ambito',    countBy(statsData,'ambito')],
        ['AS per Clienti',   countBy(statsData,'clienti')]
      ];
      for (const [title, dataObj] of configs) {
        const b64 = makeChartImage(title, dataObj);
        const imgId = wb.addImage({ base64: b64, extension: 'png' });
        ws1.addImage(imgId, {
          tl: { col: 0, row },
          br: { col: 5, row: row + 15 }
        });
        row += 16;
      }

      // ‚Äî‚Äî‚Äî‚Äî Sheet ‚ÄúDipendenti‚Äù ‚Äî‚Äî‚Äî‚Äî
      const ws2 = wb.addWorksheet('Dipendenti');
      ws2.addRow(['Nome','Cognome','Team','Ruolo','Sede','Contratto','Ambito','Clienti','Stato']);
      listData.forEach(r => {
        ws2.addRow([
          r.nome, r.cognome, r.team, r.ruolo || '',
          r.sede, r.contratto,
          Array.isArray(r.ambito)? r.ambito.join(', '): (r.ambito||''),
          Array.isArray(r.clienti)? r.clienti.join(', '): (r.clienti||''),
          r.stato || ''
        ]);
      });

      // Esporta
      const buf = await wb.xlsx.writeBuffer();
      console.log('‚úÖ Workbook creato, dimensione:', buf.byteLength);
      saveAs(new Blob([buf]), 'Report_Gestionale_Dipendenti.xlsx');
      console.log('üöÄ Download avviato');
    }

    document.getElementById('btnExport').addEventListener('click', generateExcel);
  })();
  </script>

  <!-- Phantom Scripts (se usano) -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/browser.min.js"></script>
  <script src="assets/js/breakpoints.min.js"></script>
  <script src="assets/js/util.js"></script>
  <script src="assets/js/main.js"></script>

</body>
</html>