<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Dipendenti – Gestionale</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- Phantom CSS -->
  <link rel="stylesheet" href="assets/css/main.css"/>
  <noscript><link rel="stylesheet" href="assets/css/noscript.css"/></noscript>
  <!-- Tuo CSS -->
  <link rel="stylesheet" href="style.css"/>

  <!-- 1) Carico Supabase PRIMA di qualunque script -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- 2) Carico Chart.js (serve in statistiche ma non disturba qui) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>

  <!-- Banner + Back -->
  <section id="banner" class="small">
    <div class="inner">
      <a href="index.html" class="button small">← Home</a>
      <h2>Dipendenti</h2>
    </div>
  </section>

  <!-- Form + Tabella -->
  <section id="main" class="wrapper">
    <div class="inner">

      <form id="asForm">
        <div class="fields">
          <div class="field half"><input id="inName"     type="text" placeholder="Nome"       required/></div>
          <div class="field half"><input id="inSurname"  type="text" placeholder="Cognome"    required/></div>
          <div class="field half"><input id="inTeam"     type="text" placeholder="Team"       required/></div>
          <div class="field half"><input id="inRole"     type="text" placeholder="Ruolo" /></div>
          <div class="field half"><input id="inSede"     type="text" placeholder="Sede"       required/></div>
          <div class="field half">
            <select id="inContract">
              <option>Indeterminato</option>
              <option>Determinato</option>
            </select>
          </div>
          <div class="field half"><input id="inAmbito"   type="text" placeholder="Ambito (csv)"/></div>
          <div class="field half"><input id="inClients"  type="text" placeholder="Clienti (csv)"/></div>
          <div class="field half"><input id="inState"    type="text" placeholder="Stato"/></div>
        </div>
        <ul class="actions">
          <li><input id="btnAdd" type="button" value="Aggiungi AS" class="primary"/></li>
        </ul>
      </form>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Nome</th><th>Cognome</th><th>Team</th><th>Ruolo</th>
              <th>Sede</th><th>Contratto</th><th>Ambito</th><th>Clienti</th>
              <th>Stato</th><th>Azioni</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>

    </div>
  </section>

  <!-- Phantom JS -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/browser.min.js"></script>
  <script src="assets/js/breakpoints.min.js"></script>
  <script src="assets/js/util.js"></script>
  <script src="assets/js/main.js"></script>

  <!-- Il tuo script “in pagina”, con le chiavi corrette e la tabella giusta -->
  <script>
    // CONFIG SUPABASE
    const sb = supabase.createClient(
      'https://fzbpucvscnfyimefrvzs.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…'
    );
    const TABLE = 'application_specialists';

    // All’interno di this page
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnAdd').onclick = addAS;
      loadList();
    });

    async function loadList() {
      const tbody = document.getElementById('listBody');
      tbody.innerHTML = '';
      const { data, error } = await sb.from(TABLE).select('*').order('created_at',{ascending:false});
      if (error) return alert('Errore caricamento: '+error.message);
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.nome}</td><td>${r.cognome}</td><td>${r.team}</td><td>${r.ruolo||''}</td>
          <td>${r.sede}</td><td>${r.contratto}</td>
          <td>${(r.ambito||[]).join(', ')}</td>
          <td>${(r.clienti||[]).join(', ')}</td><td>${r.stato||''}</td>
          <td><button data-id="${r.id}">✕</button></td>`;
        tr.querySelector('button').onclick = () => deleteAS(r.id);
        tbody.appendChild(tr);
      });
    }

    async function addAS() {
      const n = id => document.getElementById(id).value.trim();
      const record = {
        nome:      n('inName'),
        cognome:   n('inSurname'),
        team:      n('inTeam'),
        ruolo:     n('inRole'),
        sede:      n('inSede'),
        contratto: n('inContract'),
        ambito:    n('inAmbito').split(',').map(s=>s.trim()).filter(s=>s),
        clienti:   n('inClients').split(',').map(s=>s.trim()).filter(s=>s),
        stato:     n('inState'),
      };
      const { error } = await sb.from(TABLE).insert(record);
      if (error) return alert('Errore inserimento: '+error.message);
      ['inName','inSurname','inTeam','inRole','inSede','inContract','inAmbito','inClients','inState']
        .forEach(id=>document.getElementById(id).value='');
      loadList();
    }

    async function deleteAS(id) {
      if (!confirm('Eliminare questo AS?')) return;
      const { error } = await sb.from(TABLE).delete().eq('id',id);
      if (error) return alert('Errore eliminazione: '+error.message);
      loadList();
    }
  </script>
</body>
</html>